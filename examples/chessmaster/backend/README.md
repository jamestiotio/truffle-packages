# Truffle Bot for Chessmaster

`backend/supabase/functions/chessmaster-endpoint` is a supabase edge function written in Deno. It serves as Truffle Bot for the Chessmaster Truffle package. This function has to major pieces to it:
* Receives webhooks generated by the Truffle API when a user redeems the "Make a move" collectible.
* Streams events to/from the Lichess API.

If you would like to explore the code further, the majority of the relevant functionality can be found in the `index.ts` and the `utils/chess.ts` files.

### Deploying Truffle Bot
To get setup on the Supabase side of things you can follow the guide from the Supabase official [docs](https://supabase.com/docs/guides/functions#creating-a-function).

* Install the `supabase` CLI. [Docs](https://supabase.com/docs/reference/cli/installing-and-updating)
* Login to the CLI `supabase login`. [Docs](https://supabase.com/docs/reference/cli/supabase-login)
* You can skip the `supabase init` step and repurpose the `supabase/` folder and `config.toml` file from the forked `@truffle/events-demo-backend` package. If you skip `supabase init` you will need to create a project through the [Supabase Admin Dashboard](https://app.supabase.com/) and update the `project_id` field inside of the `config.toml`.
* Link to your remote Supabase project with `supabase link --project-ref <ref>`. You can find your project ref if you click on the project in the Supabase Admin and grab the ref from the url e.g `https://app.supabase.com/project/<ref>` [Docs](https://supabase.com/docs/reference/cli/supabase-link) 
* If you're using the Supabase Edge Function template, you will need to set `TRUFFLE_API_KEY` inside of `backend/supabase/.env` to sign requests the function makes to the Truffle Graphl API. You can copy the generated Truffle Package API key from `truffle.secret.mjs` for the Supabase secret.
* You will also need to set `LICHESS_API_TOKEN` inside of `backend/supabase/.env` to an API key of your own Lichess bot account. You can find instructions for creating a Lichess bot account at https://lichess.org/api#operation/botAccountUpgrade.
* Deploy the Supabase Edge Function `supabase functions deploy chessmaster-endpoint --no-verify-jwt` (replace `chessmaster-endpoint` with whatever you named the function directory inside of `supbase/functions/`). **Note: Make sure you deploy the function with the `--no-verify-jwt` flag so that the function can receive requests from Truffle API webhooks**
* To "wake up Truffle Bot" or just test out executing the remote function, run:
```shell
curl -L -X POST '<supabase function url>' --data '{"name":"Functions"}'
```
* Update the EventSubscription webhook action endpoint attribute with the public url of the Supabase Edge Function inside of the `truffle.config.mjs` `installActionRel` field. This is required to create the webhook for the edge function